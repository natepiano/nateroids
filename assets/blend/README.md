# Nateroid Texture Baking Workflow

## Overview

This directory contains the Blender workflow for baking the nateroid PBR textures from procedural materials with vertex colors (sprinkles) to texture maps that can be used in the Bevy game engine.

## Files

- **nateroid.blend** - Source file with procedural materials (DO NOT modify directly for baking)
- **nateroid_bake.blend** - Prepared file ready for texture baking (generated by prepare_for_bake.py)
- **prepare_for_bake.py** - Prepares the source file for baking
- **nateroid_bake_config.json** - Configuration for the baking process

## Why Two Blend Files?

**nateroid.blend** contains procedural materials with:
- Geometry nodes that instance sprinkles on the icing
- ColorRamp nodes that assign colors/metallic/roughness based on random values
- No baked vertex colors

**nateroid_bake.blend** is a prepared version where:
- Geometry nodes are applied/realized into actual mesh vertices
- Random values are converted to vertex colors that can be baked
- Materials are updated to read from vertex colors instead of procedural nodes
- UV maps are properly unwrapped and packed

**Why separate?** The preparation process is destructive (applies modifiers, realizes instances, converts procedural data to vertex attributes). Keeping the source file intact allows us to modify materials, tweak sprinkle distribution, etc., then re-run the prep script.

## prepare_for_bake.py

This script transforms the procedural source into a bake-ready file:

1. **Extracts ColorRamp data** - Reads color stops from the Sprinkles material's ColorRamp
2. **Sets up geometry nodes** - Adds Random Value → Store Named Attribute nodes to preserve sprinkle randomness
3. **Applies modifier** - Realizes instances (sprinkles become actual geometry)
4. **Converts to vertex colors** - Evaluates the ColorRamp for each vertex and stores as vertex colors
5. **Updates materials** - Connects Vertex Color nodes to replace procedural ColorRamp nodes
6. **UV unwrapping** - Ensures both donut and icing have proper UV layouts
7. **Saves as nateroid_bake.blend** - Outputs the bake-ready file

## Why EMIT Baking for Albedo?

The baking script (~/.claude/scripts/bake_textures.py) uses **EMIT** instead of **DIFFUSE** for albedo textures:

- **DIFFUSE bake** = Base color × Current lighting (includes shadows, lighting)
  - Result: Dark browns in shadowed areas, even if material is light tan
  - ❌ Wrong for PBR workflow

- **EMIT bake** = Just the emission color (no lighting calculation)
  - Result: Pure base color values as defined in material
  - ✓ Correct for PBR albedo maps

Since we set up emission nodes connected to the base color during baking, EMIT captures the actual material colors without any lighting contamination.

## Baking Process

```bash
# 1. Prepare the source file
cd ~/rust/nateroids/assets/blend
/opt/homebrew/bin/blender --background nateroid.blend --python prepare_for_bake.py

# 2. Bake textures
/opt/homebrew/bin/blender --background nateroid_bake.blend \
  --python ~/.claude/scripts/bake_textures.py -- nateroid_bake_config.json
```

This generates:
- Albedo, Normal, Metallic, Roughness, AO textures (per-object)
- Metallic-Roughness packed textures (glTF/Bevy format)
- nateroid.glb export

## Important Notes

- **Sprinkle colors come from vertex colors** - The ColorRamp mapping is baked into vertex data
- **Multi-material setup** - Both donut and icing materials must be processed together
- **Emission workaround** - Complex material inputs are temporarily connected to emission for baking
- **Resolution**: 512×512 (configured in nateroid_bake_config.json)
- **Bake margin**: 16px to prevent seams

## Bevy Material Setup

In Bevy, the baked textures require specific scalar values:

```rust
StandardMaterial {
    base_color_texture: Some(albedo),
    metallic_roughness_texture: Some(metallic_roughness),
    // CRITICAL: Set to 1.0 to use texture values directly
    metallic: 1.0,
    perceptual_roughness: 1.0,
    ..default()
}
```

Without `metallic: 1.0`, Bevy multiplies texture values by 0.0 (default), making metallic sprinkles appear non-metallic!
